app-id: com.st.STM32CubeIDE
runtime: org.gnome.Platform
runtime-version: '44'
sdk: org.gnome.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.openjdk17
command: stm32cubeide
finish-args:
  - --socket=x11
  - --socket=pulseaudio
  - --share=network
  - --filesystem=home
  - --device=all
  - --env=PATH=/app/bin:/app/jdk/bin:/usr/bin
  - --persist=.eclipse
  - --persist=.java
  - --persist=.stmcube
  - --persist=STM32Cube
  - --persist=.saros
modules:
  - name: openjdk
    buildsystem: simple
    build-commands:
      - /usr/lib/sdk/openjdk17/installjdk.sh

  - name: ncurses
    no-autogen: true
    config-opts:
      - --prefix=${FLATPAK_DEST}
      - --with-shared
      - --with-termlib=tinfo
      - --with-abi-version=5
    make-install-args:
      - install.libs
    cleanup:
      - /bin
      - /include
      - /share/man
      - /lib/*.a
      - /lib/*.la
    sources:
      - type: archive
        url: https://ftp.gnu.org/gnu/ncurses/ncurses-6.4.tar.gz
        sha256: 6931283d9ac87c5073f30b6290c4c75f21632bb4fc3603ac8100812bed248159
        x-checker-data:
          type: anitya
          project-id: 234776
          stable-only: true
          url-template: https://ftp.gnu.org/gnu/ncurses/ncurses-$version.tar.gz

  - shared-modules/libusb/libusb.json

  - name: stm32cubeide
    buildsystem: simple
    build-commands:
      - mkdir ${FLATPAK_DEST}/stm32cubeide
      - chmod +x st-stlink-server.2.1.1-1-linux-amd64.install.sh
      - ./st-stlink-server.2.1.1-1-linux-amd64.install.sh --tar -xvf
      - mv stlink-server ${FLATPAK_DEST}/bin/stlink-server
      - chmod +x st-stm32cubeide_1.14.0_19471_20231121_1200_amd64.sh
      - ./st-stm32cubeide_1.14.0_19471_20231121_1200_amd64.sh --tar -xvf
      - tar -xzvf st-stm32cubeide_1.14.0_19471_20231121_1200_amd64.tar.gz -C ${FLATPAK_DEST}/stm32cubeide/
      - install -D icon.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
      - install -t ${FLATPAK_DEST}/share/applications/ -Dm644 com.st.STM32CubeIDE.desktop
      - install -t ${FLATPAK_DEST}/share/appdata/ -Dm644 com.st.STM32CubeIDE.metainfo.xml
      - install -t ${FLATPAK_DEST}/bin -Dm755 stm32cubeide
    sources:
      - type: archive
        url: https://www.st.com/content/ccc/resource/technical/software/sw_development_suite/group0/d5/ca/d8/d4/64/90/42/e1/stm32cubeide-lnx/files/st-stm32cubeide_1.14.0_19471_20231121_1200_amd64.sh.zip/jcr:content/translations/en.st-stm32cubeide_1.14.0_19471_20231121_1200_amd64.sh.zip
        sha256: cdd131fcaa3781ed3695bce315ee064e3a50cd971869d27b39c99f8d8e77f7cc
      - type: archive
        url: https://www.st.com/content/ccc/resource/technical/software/sw_development_suite/group0/98/41/e8/53/44/80/41/92/st-link-server-v2-1-1/files/st-link-server-v2-1-1.zip/jcr:content/translations/en.st-link-server-v2-1-1.zip
        sha256: a84a0ada7c9b6343e559dacd37e42a815c500d0f4a517db3d1e511d056903bf6
      - type: file
        path: com.st.STM32CubeIDE.metainfo.xml
      - type: file
        path: com.st.STM32CubeIDE.desktop
      - type: file
        path: icon.png
      - type: script
        dest-filename: stm32cubeide
        commands:
          - unset FLATPAK_SANDBOX_DIR
          - exec /app/stm32cubeide/stm32cubeide "$@"
